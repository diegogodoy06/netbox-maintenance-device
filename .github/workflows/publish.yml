name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no publish)'
        required: false
        default: false
        type: boolean
      version:
        description: 'Version to publish (optional, reads from pyproject.toml if empty)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  build:
    name: Build distribution ðŸ“¦
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Get version from pyproject.toml
        id: get-version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])" 2>/dev/null || python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"
          
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "setuptools>=61.0" wheel "build>=1.0.0" "twine>=4.0.0"
          
      - name: Clean previous builds
        run: |
          rm -rf dist/ build/ *.egg-info/
          
      - name: Verify pyproject.toml
        run: |
          echo "ðŸ” Checking pyproject.toml structure..."
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              config = tomllib.load(f)
              if 'project' not in config:
                  raise ValueError('Missing [project] section in pyproject.toml')
              if 'name' not in config['project']:
                  raise ValueError('Missing name in [project] section')
              if 'version' not in config['project']:
                  raise ValueError('Missing version in [project] section')
              print(f\"âœ… Valid pyproject.toml: {config['project']['name']} v{config['project']['version']}\")
          "
          
      - name: Build package
        run: |
          echo "ðŸ”¨ Building distribution packages..."
          python -m build --sdist --wheel
          
      - name: Verify build outputs
        run: |
          echo "ðŸ“‹ Built packages:"
          ls -lah dist/
          echo ""
          echo "ðŸ” Checking wheel metadata:"
          python -c "
          import zipfile
          import glob
          wheel_files = glob.glob('dist/*.whl')
          if not wheel_files:
              print('âŒ No wheel files found!')
              exit(1)
          for whl in wheel_files:
              with zipfile.ZipFile(whl, 'r') as z:
                  metadata_files = [f for f in z.namelist() if 'METADATA' in f or 'PKG-INFO' in f]
                  if metadata_files:
                      print(f'âœ… {whl}: Found metadata')
                      # Read and display key metadata
                      content = z.read(metadata_files[0]).decode('utf-8')
                      for line in content.split('\n')[:10]:
                          if line.startswith(('Name:', 'Version:', 'Summary:')):
                              print(f'   {line}')
                  else:
                      print(f'âŒ {whl}: No metadata found!')
                      exit(1)
          "
          echo ""
          echo "ðŸ” Running twine check..."
          python -m twine check dist/*
          echo "âœ… All validations passed!"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 7

  publish:
    name: Publish to PyPI ðŸš€
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && !inputs.dry_run)
    needs: [build]
    runs-on: ubuntu-latest
    
    environment:
      name: pypi
      url: https://pypi.org/project/netbox-maintenance-device/
      
    permissions:
      id-token: write
      
    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Verify downloaded packages
        run: |
          echo "ðŸ“‹ Downloaded packages:"
          ls -lah dist/
          echo ""
          echo "ðŸ” Quick metadata check:"
          python -m zipfile -l dist/*.whl 2>/dev/null | grep -E "(METADATA|PKG-INFO|dist-info)" | head -5 || echo "Note: Using alternate verification..."
          
      - name: Final validation
        run: |
          python -m pip install --upgrade pip
          pip install "twine>=4.0.0"
          echo "ðŸ” Running final twine validation..."
          python -m twine check --strict dist/*
          echo "âœ… Validation passed!"
          
      - name: Check if version exists on PyPI
        id: check-version
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "ðŸ” Checking if version $VERSION already exists on PyPI..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/netbox-maintenance-device/$VERSION/json")
          if [ "$HTTP_CODE" = "404" ]; then
            echo "version-exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Version $VERSION is available for upload"
          else
            echo "version-exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Version $VERSION already exists on PyPI"
          fi
          
      - name: Publish to PyPI
        if: steps.check-version.outputs.version-exists == 'false'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true
          print-hash: true
          
      - name: Skip upload (version exists)
        if: steps.check-version.outputs.version-exists == 'true'
        run: |
          echo "âš ï¸ Version ${{ needs.build.outputs.version }} already exists on PyPI"
          echo "ðŸ”„ Skipping upload to prevent conflict"
          echo "ðŸ’¡ To publish a new version, update the version in pyproject.toml"
          
      - name: Create GitHub Release Summary
        if: success() && steps.check-version.outputs.version-exists == 'false'
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "ðŸŽ‰ **Publication successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Package:** netbox-maintenance-device" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **PyPI:** https://pypi.org/project/netbox-maintenance-device/$VERSION/" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Install:** \`pip install netbox-maintenance-device==$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Install Latest:** \`pip install netbox-maintenance-device\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Status:** Ready for installation worldwide!" >> $GITHUB_STEP_SUMMARY
          
      - name: Create GitHub Release Summary (Skip)
        if: steps.check-version.outputs.version-exists == 'true'
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "âš ï¸ **Upload skipped**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Package:** netbox-maintenance-device" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Version:** $VERSION (already exists)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **PyPI:** https://pypi.org/project/netbox-maintenance-device/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Next steps:** Update version in pyproject.toml and try again" >> $GITHUB_STEP_SUMMARY
