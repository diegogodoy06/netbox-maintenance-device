{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'Notification Test' %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>üîî Teste de Notifica√ß√µes</h3>
                </div>
                <div class="card-body">
                    <p><strong>Usu√°rio:</strong> {{ user.username }}</p>
                    <p><strong>Total de notifica√ß√µes:</strong> <span id="total-notifications">Carregando...</span></p>
                    <p><strong>N√£o lidas:</strong> <span id="unread-notifications">Carregando...</span></p>
                    
                    <button class="btn btn-primary" onclick="testNotifications()">Atualizar</button>
                    <button class="btn btn-success" onclick="requestPermission()">Solicitar Permiss√£o</button>
                    
                    <div id="notification-list" class="mt-3">
                        <!-- Notifica√ß√µes aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testNotifications() {
    console.log('Testing notifications...');
    
    fetch('{% url "plugins:netbox_maintenance_device:api_unread_notifications" %}')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Unread notifications data:', data);
            document.getElementById('unread-notifications').textContent = data.count || 0;
            
            const listElement = document.getElementById('notification-list');
            if (data.notifications && data.notifications.length > 0) {
                listElement.innerHTML = '<h5>Notifica√ß√µes n√£o lidas:</h5>';
                data.notifications.forEach(notif => {
                    listElement.innerHTML += `
                        <div class="alert alert-info">
                            <strong>${notif.title}</strong><br>
                            <small>${notif.message}</small><br>
                            <em>Prioridade: ${notif.priority} | Tipo: ${notif.notification_type}</em>
                        </div>
                    `;
                });
            } else {
                listElement.innerHTML = '<div class="alert alert-success">Nenhuma notifica√ß√£o n√£o lida encontrada.</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching notifications:', error);
            document.getElementById('unread-notifications').textContent = 'Erro!';
            document.getElementById('notification-list').innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
        });
}

function requestPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                new Notification('NetBox - Teste', {
                    body: 'Notifica√ß√µes habilitadas com sucesso!',
                });
            }
        });
    } else {
        alert('Este navegador n√£o suporta notifica√ß√µes.');
    }
}

// Auto-run test when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(testNotifications, 1000);
});
</script>
{% endblock %}
