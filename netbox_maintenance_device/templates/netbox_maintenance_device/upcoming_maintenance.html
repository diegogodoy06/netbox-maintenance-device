{% extends 'generic/object_list.html' %}
{% load render_table from django_tables2 %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'netbox_maintenance_device/css/maintenance.css' %}">
{% endblock %}

{% block title %}{% trans "Upcoming & Overdue Maintenance" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col col-md-12">
        <!-- Overdue Maintenance Alert -->
        {% if overdue_count > 0 %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="mdi mdi-alert-circle-outline"></i>
            <strong>{% trans "Attention!" %}</strong> 
            {% blocktrans count counter=overdue_count %}
                There is {{ counter }} overdue maintenance item that requires immediate attention.
            {% plural %}
                There are {{ counter }} overdue maintenance items that require immediate attention.
            {% endblocktrans %}
        </div>
        {% endif %}
        
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-calendar-alert"></i> {% trans "Upcoming & Overdue Maintenance" %}
                <span class="badge badge-secondary float-right">{{ table.data|length }}</span>
            </h5>
            <div class="card-body">
                {% if table.data %}
                    {% render_table table 'inc/table.html' %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="mdi mdi-information"></i>
                        {% trans "No upcoming or overdue maintenance found." %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Completion Modal -->
<div class="modal fade" id="quickCompleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Complete Maintenance" %}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="quickCompleteForm">
                    {% csrf_token %}
                    <input type="hidden" id="planId" name="plan_id">
                    <input type="hidden" id="deviceId" name="device_id">
                    <div class="form-group">
                        <label for="technician">{% trans "Technician" %}</label>
                        <input type="text" class="form-control" id="technician" name="technician" 
                               value="{% if user.is_authenticated %}{{ user.get_full_name|default:user.username }}{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">{% trans "Notes" %}</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="{% trans 'Maintenance completed successfully' %}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-success" id="confirmComplete">
                    <i class="mdi mdi-check"></i> {% trans "Complete Maintenance" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Schedule Maintenance" %}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    {% csrf_token %}
                    <input type="hidden" id="schedulePlanId" name="plan_id">
                    <div class="form-group">
                        <label for="scheduledDate">{% trans "Scheduled Date" %}</label>
                        <input type="date" class="form-control" id="scheduledDate" name="scheduled_date" required>
                    </div>
                    <div class="form-group">
                        <label for="scheduleTechnician">{% trans "Technician" %}</label>
                        <input type="text" class="form-control" id="scheduleTechnician" name="technician" 
                               value="{% if user.is_authenticated %}{{ user.get_full_name|default:user.username }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label for="scheduleNotes">{% trans "Notes" %}</label>
                        <textarea class="form-control" id="scheduleNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="confirmSchedule">
                    <i class="mdi mdi-calendar-plus"></i> {% trans "Schedule Maintenance" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function($) {
    'use strict';
    
    // Setup CSRF token for AJAX requests
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function setupMaintenanceHandlers() {
        console.log('Setting up maintenance action handlers');
        
        var csrftoken = getCookie('csrftoken');
        
        // Setup AJAX with CSRF token
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        
        // Handle quick completion - use event delegation
        $(document).off('click', '.quick-complete-btn').on('click', '.quick-complete-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Quick complete button clicked');
            
            var $btn = $(this);
            var planId = $btn.data('plan-id');
            var deviceId = $btn.data('device-id');
            var planName = $btn.data('plan-name');
            
            console.log('Plan ID:', planId, 'Device ID:', deviceId, 'Plan Name:', planName);
            
            $('#planId').val(planId);
            $('#deviceId').val(deviceId);
            $('#quickCompleteModal .modal-title').text('{% trans "Complete Maintenance" %}: ' + planName);
            $('#quickCompleteModal').modal('show');
            
            return false;
        });
        
        // Handle schedule maintenance - use event delegation
        $(document).off('click', '.schedule-btn').on('click', '.schedule-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Schedule button clicked');
            
            var $btn = $(this);
            var planId = $btn.data('plan-id');
            var planName = $btn.data('plan-name');
            
            console.log('Plan ID:', planId, 'Plan Name:', planName);
            
            $('#schedulePlanId').val(planId);
            $('#scheduleModal .modal-title').text('{% trans "Schedule Maintenance" %}: ' + planName);
            
            // Set default date to tomorrow
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            $('#scheduledDate').val(tomorrow.toISOString().split('T')[0]);
            
            $('#scheduleModal').modal('show');
            
            return false;
        });
    
    // Handle complete form submission
    $('#confirmComplete').click(function() {
        var $btn = $(this);
        $btn.prop('disabled', true).html('<i class="mdi mdi-loading mdi-spin"></i> {% trans "Processing..." %}');
        
        var formData = $('#quickCompleteForm').serialize();
        
        $.ajax({
            url: '{% url "plugins:netbox_maintenance_device:quick_complete" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    $('#quickCompleteModal').modal('hide');
                    location.reload();
                } else {
                    alert('{% trans "Error completing maintenance" %}: ' + response.error);
                    $btn.prop('disabled', false).html('<i class="mdi mdi-check"></i> {% trans "Complete Maintenance" %}');
                }
            },
            error: function() {
                alert('{% trans "Error completing maintenance. Please try again." %}');
                $btn.prop('disabled', false).html('<i class="mdi mdi-check"></i> {% trans "Complete Maintenance" %}');
            }
        });
    });
    
    // Handle schedule form submission
    $('#confirmSchedule').click(function() {
        var $btn = $(this);
        $btn.prop('disabled', true).html('<i class="mdi mdi-loading mdi-spin"></i> {% trans "Scheduling..." %}');
        
        var formData = $('#scheduleForm').serialize();
        
        $.ajax({
            url: '{% url "plugins:netbox_maintenance_device:schedule_maintenance" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    $('#scheduleModal').modal('hide');
                    location.reload();
                } else {
                    alert('{% trans "Error scheduling maintenance" %}: ' + response.error);
                    $btn.prop('disabled', false).html('<i class="mdi mdi-calendar-plus"></i> {% trans "Schedule Maintenance" %}');
                }
            },
            error: function() {
                alert('{% trans "Error scheduling maintenance. Please try again." %}');
                $btn.prop('disabled', false).html('<i class="mdi mdi-calendar-plus"></i> {% trans "Schedule Maintenance" %}');
            }
        });
    });
    
        // Reset forms when modals are hidden
        $('#quickCompleteModal').on('hidden.bs.modal', function() {
            $('#quickCompleteForm')[0].reset();
            $('#confirmComplete').prop('disabled', false).html('<i class="mdi mdi-check"></i> {% trans "Complete Maintenance" %}');
        });
        
        $('#scheduleModal').on('hidden.bs.modal', function() {
            $('#scheduleForm')[0].reset();
            $('#confirmSchedule').prop('disabled', false).html('<i class="mdi mdi-calendar-plus"></i> {% trans "Schedule Maintenance" %}');
        });
        
        console.log('Maintenance handlers setup complete');
    }
    
    // Initialize on DOM ready and after any AJAX table updates
    $(document).ready(function() {
        setupMaintenanceHandlers();
    });
    
    // Re-initialize after table reloads (for pagination, sorting, etc.)
    $(document).on('DOMContentLoaded', setupMaintenanceHandlers);
    
})(jQuery);
</script>
{% endblock %}